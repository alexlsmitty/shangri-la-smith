const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/supabase-Cp8GKqtU.js","assets/index-kzOsGLs0.js","assets/index-Dqi0_wB7.css"])))=>i.map(i=>d[i]);
import{_ as Q,r as V,w as X,c as T,a as d,b as G,o as q,d as A,e as a,f as l,g as s,h as y,t as u,i as M,u as ee,j as te,k as Y}from"./index-kzOsGLs0.js";const ae={class:"booking-form"},le={key:0,class:"booking-confirmation"},oe={class:"mb-2"},se={class:"d-flex justify-space-between mb-2"},ne={class:"d-flex justify-space-between mb-2"},ie={class:"d-flex justify-space-between mb-2"},re={class:"d-flex justify-space-between mb-2"},ue={class:"d-flex justify-space-between mb-2"},de={class:"font-weight-bold"},ce={class:"text-center"},me={class:"room-summary mb-6"},ve={class:"text-h5 font-weight-bold"},fe={class:"text-subtitle-2"},pe={class:"d-flex align-center"},be={class:"text-h6 font-weight-bold text-primary"},he={class:"d-flex justify-space-between mb-2"},ge={class:"d-flex justify-space-between text-h6 font-weight-bold"},ke={__name:"BookingForm",props:{room:{type:Object,required:!0}},emits:["booking-completed"],setup(_,{emit:Z}){const N=_,H=Z,m={required:i=>!!i||"Required field",email:i=>/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(i)||"Invalid email address",phone:i=>/^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/.test(i)||"Invalid phone number"},C=V(!1),P=V(null),U=V(!1),E=V(""),$=N.room.formData||{},t=V({checkInDate:$.checkInDate||"",checkOutDate:$.checkOutDate||"",adults:$.adults||1,children:$.children||0,firstName:"",lastName:"",email:"",phone:"",specialRequests:"",paymentMethod:"credit-card",agreeToTerms:!1}),x=V(!0),j=V(!1);async function K(){if(!(!t.value.checkInDate||!t.value.checkOutDate))try{j.value=!0;const{selectData:i}=await Y(async()=>{const{selectData:b}=await import("./supabase-Cp8GKqtU.js").then(r=>r.a);return{selectData:b}},__vite__mapDeps([0,1,2])),e=new Date(t.value.checkInDate),o=new Date(t.value.checkOutDate),g=[];let p=new Date(e);for(;p<o;)g.push(p.toISOString().split("T")[0]),p.setDate(p.getDate()+1);console.log("Checking availability for dates:",g);let k=!0;for(const b of g){const r=await i("room_availability",{select:"*",filters:{room_type_id:N.room.id,date:b}});if(console.log(`Availability for ${b}:`,r),!r||r.length===0||r[0].available_rooms<=0){k=!1;break}}x.value=k,console.log("Room availability result:",x.value)}catch(i){console.error("Error checking availability:",i),x.value=!1}finally{j.value=!1}}X([()=>t.value.checkInDate,()=>t.value.checkOutDate],()=>{t.value.checkInDate&&t.value.checkOutDate&&K()});const R=T(()=>{if(!t.value.checkInDate||!t.value.checkOutDate)return 0;const i=new Date(t.value.checkInDate),o=new Date(t.value.checkOutDate).getTime()-i.getTime();return Math.ceil(o/(1e3*3600*24))}),F=T(()=>parseInt(N.room.price.replace(/[^0-9]/g,""))),B=T(()=>R.value*F.value),z=new Date().toISOString().split("T")[0],W=T(()=>{if(!t.value.checkInDate)return z;const i=new Date(t.value.checkInDate);return i.setDate(i.getDate()+1),i.toISOString().split("T")[0]}),L=T(()=>t.value.checkInDate&&t.value.checkOutDate&&t.value.firstName&&t.value.lastName&&t.value.email&&m.email(t.value.email)===!0&&t.value.phone&&m.phone(t.value.phone)===!0&&t.value.agreeToTerms);async function J(){var i,e;if(!L.value){alert("Please fill in all required fields correctly.");return}if(!x.value){alert("We're sorry, this room is no longer available for the selected dates. Please try different dates.");return}C.value=!0,P.value=null;try{const o={roomTypeId:N.room.id,checkInDate:t.value.checkInDate,checkOutDate:t.value.checkOutDate,adults:t.value.adults,children:t.value.children,firstName:t.value.firstName,lastName:t.value.lastName,email:t.value.email,phone:t.value.phone,specialRequests:t.value.specialRequests,paymentMethod:t.value.paymentMethod,totalPrice:B.value};o.roomTypeId=parseInt(o.roomTypeId,10);const{insertData:g,updateData:p,selectData:k}=await Y(async()=>{const{insertData:c,updateData:f,selectData:h}=await import("./supabase-Cp8GKqtU.js").then(S=>S.a);return{insertData:c,updateData:f,selectData:h}},__vite__mapDeps([0,1,2])),b=`BOOK-${new Date().getFullYear()}-${Math.floor(1e3+Math.random()*9e3)}`,r=await g("bookings",{reference:b,guest_name:`${o.firstName} ${o.lastName}`,guest_email:o.email,check_in_date:o.checkInDate,check_out_date:o.checkOutDate,room_type_id:o.roomTypeId,guests_count:o.adults+o.children,special_requests:o.specialRequests,total_price:o.totalPrice,status:"confirmed"}),D=new Date(o.checkInDate),w=new Date(o.checkOutDate),v=[];let I=new Date(D);for(;I<w;)v.push(I.toISOString().split("T")[0]),I.setDate(I.getDate()+1);console.log("Booking dates:",v),console.log("Room type ID:",o.roomTypeId);let O=!0;for(const c of v)try{console.log(`Checking availability for date ${c}`);const f=await k("room_availability",{select:"*",filters:{room_type_id:o.roomTypeId,date:c}});if(console.log("Availability data:",f),f&&f.length>0){const h=f[0];console.log(`Current available rooms for ${c}:`,h.available_rooms),h.available_rooms>0?(await p("room_availability",{available_rooms:Math.max(0,h.available_rooms-1)},{id:h.id}),console.log(`Updated availability for ${c} to ${h.available_rooms-1} rooms`)):(console.warn(`No rooms available for ${c}!`),O=!1)}else console.warn(`No availability record found for ${c}`),O=!1}catch(f){console.error(`Error updating availability for ${c}:`,f),O=!1}if(!O)throw new Error("Some dates are no longer available for booking.");E.value=b,U.value=!0,H("booking-completed")}catch(o){console.error("Error creating booking:",o),P.value=((e=(i=o.response)==null?void 0:i.data)==null?void 0:e.error)||"An unexpected error occurred while processing your booking."}finally{C.value=!1}}return(i,e)=>{const o=d("v-alert"),g=d("v-card-text"),p=d("v-card"),k=d("v-btn"),b=d("v-img"),r=d("v-col"),D=d("v-row"),w=d("v-divider"),v=d("v-text-field"),I=d("v-select"),O=d("v-textarea"),c=d("v-radio"),f=d("v-radio-group"),h=d("v-checkbox"),S=d("v-form");return q(),G("div",ae,[U.value?(q(),G("div",le,[a(o,{type:"success",variant:"tonal",class:"mb-4"},{default:s(()=>[e[14]||(e[14]=l("h3",{class:"text-h5 mb-2"},"Booking Confirmed!",-1)),l("p",oe,[e[11]||(e[11]=y("Your booking reference is: ")),l("strong",null,u(E.value),1)]),l("p",null,[e[12]||(e[12]=y("A confirmation email has been sent to ")),l("strong",null,u(t.value.email),1),e[13]||(e[13]=y("."))])]),_:1}),a(p,{class:"mb-4",variant:"outlined"},{default:s(()=>[a(g,null,{default:s(()=>[e[20]||(e[20]=l("h3",{class:"text-h6 mb-3"},"Booking Details",-1)),l("div",se,[e[15]||(e[15]=l("span",{class:"font-weight-medium"},"Room:",-1)),l("span",null,u(_.room.title),1)]),l("div",ne,[e[16]||(e[16]=l("span",{class:"font-weight-medium"},"Check-in:",-1)),l("span",null,u(t.value.checkInDate),1)]),l("div",ie,[e[17]||(e[17]=l("span",{class:"font-weight-medium"},"Check-out:",-1)),l("span",null,u(t.value.checkOutDate),1)]),l("div",re,[e[18]||(e[18]=l("span",{class:"font-weight-medium"},"Guests:",-1)),l("span",null,u(t.value.adults)+" adults, "+u(t.value.children)+" children",1)]),l("div",ue,[e[19]||(e[19]=l("span",{class:"font-weight-medium"},"Total Price:",-1)),l("span",de,"$"+u(B.value),1)])]),_:1})]),_:1}),l("div",ce,[a(k,{color:"primary",to:"/bookings",class:"ma-2"},{default:s(()=>e[21]||(e[21]=[y(" View My Bookings ")])),_:1}),a(k,{color:"secondary",variant:"outlined",to:"/",class:"ma-2"},{default:s(()=>e[22]||(e[22]=[y(" Return to Home ")])),_:1})])])):(q(),A(S,{key:1,onSubmit:te(J,["prevent"])},{default:s(()=>[P.value?(q(),A(o,{key:0,type:"error",variant:"tonal",class:"mb-4",closable:""},{default:s(()=>[y(u(P.value),1)]),_:1})):M("",!0),!x.value&&t.value.checkInDate&&t.value.checkOutDate?(q(),A(o,{key:1,type:"warning",variant:"tonal",class:"mb-4",closable:""},{default:s(()=>e[23]||(e[23]=[y(" This room is not available for the selected dates. Please choose different dates. ")])),_:1})):M("",!0),l("div",me,[a(D,null,{default:s(()=>[a(r,{cols:"12",sm:"4"},{default:s(()=>[a(b,{src:_.room.image,height:"150",cover:"",class:"rounded"},null,8,["src"])]),_:1}),a(r,{cols:"12",sm:"8"},{default:s(()=>[l("h3",ve,u(_.room.title),1),l("p",fe,u(_.room.description),1),l("div",pe,[l("span",be,u(_.room.price),1),e[24]||(e[24]=l("span",{class:"text-body-2 ml-1"},"per night",-1))])]),_:1})]),_:1})]),a(w,{class:"mb-6"}),e[27]||(e[27]=l("h3",{class:"text-h6 font-weight-bold mb-4"},"Stay Details",-1)),a(D,null,{default:s(()=>[a(r,{cols:"12",sm:"6"},{default:s(()=>[a(v,{modelValue:t.value.checkInDate,"onUpdate:modelValue":e[0]||(e[0]=n=>t.value.checkInDate=n),label:"Check-in Date",type:"date",min:ee(z),rules:[m.required],variant:"outlined",required:""},null,8,["modelValue","min","rules"])]),_:1}),a(r,{cols:"12",sm:"6"},{default:s(()=>[a(v,{modelValue:t.value.checkOutDate,"onUpdate:modelValue":e[1]||(e[1]=n=>t.value.checkOutDate=n),label:"Check-out Date",type:"date",min:W.value,rules:[m.required],variant:"outlined",disabled:!t.value.checkInDate,required:""},null,8,["modelValue","min","rules","disabled"])]),_:1})]),_:1}),a(D,null,{default:s(()=>[a(r,{cols:"12",sm:"6"},{default:s(()=>[a(I,{modelValue:t.value.adults,"onUpdate:modelValue":e[2]||(e[2]=n=>t.value.adults=n),label:"Adults",items:[1,2,3,4],variant:"outlined",required:""},null,8,["modelValue"])]),_:1}),a(r,{cols:"12",sm:"6"},{default:s(()=>[a(I,{modelValue:t.value.children,"onUpdate:modelValue":e[3]||(e[3]=n=>t.value.children=n),label:"Children",items:[0,1,2,3,4],variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),R.value>0?(q(),A(p,{key:2,class:"mb-6",variant:"outlined"},{default:s(()=>[a(g,null,{default:s(()=>[l("div",he,[l("span",null,u(_.room.price)+" x "+u(R.value)+" nights",1),l("span",null,"$"+u(F.value*R.value),1)]),a(w,{class:"my-2"}),l("div",ge,[e[25]||(e[25]=l("span",null,"Total",-1)),l("span",null,"$"+u(B.value),1)])]),_:1})]),_:1})):M("",!0),a(w,{class:"mb-6"}),e[28]||(e[28]=l("h3",{class:"text-h6 font-weight-bold mb-4"},"Guest Information",-1)),a(D,null,{default:s(()=>[a(r,{cols:"12",sm:"6"},{default:s(()=>[a(v,{modelValue:t.value.firstName,"onUpdate:modelValue":e[4]||(e[4]=n=>t.value.firstName=n),label:"First Name",rules:[m.required],variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1}),a(r,{cols:"12",sm:"6"},{default:s(()=>[a(v,{modelValue:t.value.lastName,"onUpdate:modelValue":e[5]||(e[5]=n=>t.value.lastName=n),label:"Last Name",rules:[m.required],variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1})]),_:1}),a(D,null,{default:s(()=>[a(r,{cols:"12",sm:"6"},{default:s(()=>[a(v,{modelValue:t.value.email,"onUpdate:modelValue":e[6]||(e[6]=n=>t.value.email=n),label:"Email",type:"email",rules:[m.required,m.email],variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1}),a(r,{cols:"12",sm:"6"},{default:s(()=>[a(v,{modelValue:t.value.phone,"onUpdate:modelValue":e[7]||(e[7]=n=>t.value.phone=n),label:"Phone",rules:[m.required,m.phone],variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1})]),_:1}),a(O,{modelValue:t.value.specialRequests,"onUpdate:modelValue":e[8]||(e[8]=n=>t.value.specialRequests=n),label:"Special Requests",variant:"outlined",rows:"3"},null,8,["modelValue"]),a(w,{class:"mb-6"}),e[29]||(e[29]=l("h3",{class:"text-h6 font-weight-bold mb-4"},"Payment Method",-1)),a(f,{modelValue:t.value.paymentMethod,"onUpdate:modelValue":e[9]||(e[9]=n=>t.value.paymentMethod=n),inline:""},{default:s(()=>[a(c,{label:"Credit Card",value:"credit-card"}),a(c,{label:"PayPal",value:"paypal"}),a(c,{label:"Pay at Property",value:"at-property"})]),_:1},8,["modelValue"]),a(w,{class:"mb-6"}),a(h,{modelValue:t.value.agreeToTerms,"onUpdate:modelValue":e[10]||(e[10]=n=>t.value.agreeToTerms=n),label:"I agree to the terms and conditions",rules:[m.required],required:""},null,8,["modelValue","rules"]),a(k,{color:"primary",size:"large",type:"submit",block:"",loading:C.value,disabled:!L.value||!x.value||C.value,class:"mt-4"},{default:s(()=>e[26]||(e[26]=[y(" Complete Booking ")])),_:1},8,["loading","disabled"])]),_:1}))])}}},_e=Q(ke,[["__scopeId","data-v-fe1caabe"]]);export{_e as B};
