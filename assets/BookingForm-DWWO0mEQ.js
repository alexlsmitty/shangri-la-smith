const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/supabase-CZM_7RBb.js","assets/vendor-CRTejrwt.js","assets/styles/vendor-WOtlixU8.css"])))=>i.map(i=>d[i]);
import{r as e,w as a,e as l,f as t,g as o,o as s,h as u,i,j as n,k as r,l as c,t as d,n as m,u as v,p,_ as h}from"./vendor-CRTejrwt.js";import{_ as f}from"./index-D-3aAWvc.js";const b={class:"booking-form"},g={key:0,class:"booking-confirmation"},y={class:"mb-2"},D={class:"d-flex justify-space-between mb-2"},k={class:"d-flex justify-space-between mb-2"},_={class:"d-flex justify-space-between mb-2"},w={class:"d-flex justify-space-between mb-2"},I={class:"d-flex justify-space-between mb-2"},V={class:"font-weight-bold"},x={class:"text-center"},q={class:"room-summary mb-6"},O={class:"text-h5 font-weight-bold"},T={class:"text-subtitle-2"},N={class:"d-flex align-center"},$={class:"text-h6 font-weight-bold text-primary"},P={class:"d-flex justify-space-between mb-2"},R={class:"d-flex justify-space-between text-h6 font-weight-bold"},j=f({__name:"BookingForm",props:{room:{type:Object,required:!0}},emits:["booking-completed"],setup(f,{emit:j}){const C=f,S=j,U={required:e=>!!e||"Required field",email:e=>/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)||"Invalid email address",phone:e=>/^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/.test(e)||"Invalid phone number"},M=e(!1),A=e(null),E=e(!1),B=e(""),z=C.room.formData||{},F=e({checkInDate:z.checkInDate||"",checkOutDate:z.checkOutDate||"",adults:z.adults||1,children:z.children||0,firstName:"",lastName:"",email:"",phone:"",specialRequests:"",paymentMethod:"credit-card",agreeToTerms:!1}),L=e(!0),G=e(!1);a([()=>F.value.checkInDate,()=>F.value.checkOutDate],(()=>{F.value.checkInDate&&F.value.checkOutDate&&async function(){if(F.value.checkInDate&&F.value.checkOutDate)try{G.value=!0;const{selectData:e}=await h((async()=>{const{selectData:e}=await import("./supabase-CZM_7RBb.js");return{selectData:e}}),__vite__mapDeps([0,1,2])),a=new Date(F.value.checkInDate),l=new Date(F.value.checkOutDate),t=[];let o=new Date(a);for(;o<l;)t.push(o.toISOString().split("T")[0]),o.setDate(o.getDate()+1);console.log("Checking availability for dates:",t);let s=!0;for(const u of t){const a=await e("room_availability",{select:"*",filters:{room_type_id:C.room.id,date:u}});if(console.log(`Availability for ${u}:`,a),!a||0===a.length||a[0].available_rooms<=0){s=!1;break}}L.value=s,console.log("Room availability result:",L.value)}catch(e){console.error("Error checking availability:",e),L.value=!1}finally{G.value=!1}}()}));const Y=l((()=>{if(!F.value.checkInDate||!F.value.checkOutDate)return 0;const e=new Date(F.value.checkInDate),a=new Date(F.value.checkOutDate).getTime()-e.getTime();return Math.ceil(a/864e5)})),Z=l((()=>parseInt(C.room.price.replace(/[^0-9]/g,"")))),H=l((()=>Y.value*Z.value)),K=(new Date).toISOString().split("T")[0],W=l((()=>{if(!F.value.checkInDate)return K;const e=new Date(F.value.checkInDate);return e.setDate(e.getDate()+1),e.toISOString().split("T")[0]})),J=l((()=>F.value.checkInDate&&F.value.checkOutDate&&F.value.firstName&&F.value.lastName&&F.value.email&&!0===U.email(F.value.email)&&F.value.phone&&!0===U.phone(F.value.phone)&&F.value.agreeToTerms));async function Q(){var e,a;if(J.value)if(L.value){M.value=!0,A.value=null;try{const e={roomTypeId:C.room.id,checkInDate:F.value.checkInDate,checkOutDate:F.value.checkOutDate,adults:F.value.adults,children:F.value.children,firstName:F.value.firstName,lastName:F.value.lastName,email:F.value.email,phone:F.value.phone,specialRequests:F.value.specialRequests,paymentMethod:F.value.paymentMethod,totalPrice:H.value};e.roomTypeId=parseInt(e.roomTypeId,10);const{insertData:a,updateData:t,selectData:o}=await h((async()=>{const{insertData:e,updateData:a,selectData:l}=await import("./supabase-CZM_7RBb.js");return{insertData:e,updateData:a,selectData:l}}),__vite__mapDeps([0,1,2])),s=`BOOK-${(new Date).getFullYear()}-${Math.floor(1e3+9e3*Math.random())}`,u=(await a("bookings",{reference:s,guest_name:`${e.firstName} ${e.lastName}`,guest_email:e.email,check_in_date:e.checkInDate,check_out_date:e.checkOutDate,room_type_id:e.roomTypeId,guests_count:e.adults+e.children,special_requests:e.specialRequests,total_price:e.totalPrice,status:"confirmed"}),new Date(e.checkInDate)),i=new Date(e.checkOutDate),n=[];let r=new Date(u);for(;r<i;)n.push(r.toISOString().split("T")[0]),r.setDate(r.getDate()+1);console.log("Booking dates:",n),console.log("Room type ID:",e.roomTypeId);let c=!0;for(const d of n)try{console.log(`Checking availability for date ${d}`);const a=await o("room_availability",{select:"*",filters:{room_type_id:e.roomTypeId,date:d}});if(console.log("Availability data:",a),a&&a.length>0){const e=a[0];console.log(`Current available rooms for ${d}:`,e.available_rooms),e.available_rooms>0?(await t("room_availability",{available_rooms:Math.max(0,e.available_rooms-1)},{id:e.id}),console.log(`Updated availability for ${d} to ${e.available_rooms-1} rooms`)):(console.warn(`No rooms available for ${d}!`),c=!1)}else console.warn(`No availability record found for ${d}`),c=!1}catch(l){console.error(`Error updating availability for ${d}:`,l),c=!1}if(!c)throw new Error("Some dates are no longer available for booking.");B.value=s,E.value=!0,S("booking-completed")}catch(t){console.error("Error creating booking:",t),A.value=(null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.error)||"An unexpected error occurred while processing your booking."}finally{M.value=!1}}else alert("We're sorry, this room is no longer available for the selected dates. Please try different dates.");else alert("Please fill in all required fields correctly.")}return(e,a)=>{const l=t("v-alert"),h=t("v-card-text"),j=t("v-card"),C=t("v-btn"),S=t("v-img"),z=t("v-col"),G=t("v-row"),X=t("v-divider"),ee=t("v-text-field"),ae=t("v-select"),le=t("v-textarea"),te=t("v-radio"),oe=t("v-radio-group"),se=t("v-checkbox"),ue=t("v-form");return s(),o("div",b,[E.value?(s(),o("div",g,[i(l,{type:"success",variant:"tonal",class:"mb-4"},{default:r((()=>[a[14]||(a[14]=n("h3",{class:"text-h5 mb-2"},"Booking Confirmed!",-1)),n("p",y,[a[11]||(a[11]=c("Your booking reference is: ")),n("strong",null,d(B.value),1)]),n("p",null,[a[12]||(a[12]=c("A confirmation email has been sent to ")),n("strong",null,d(F.value.email),1),a[13]||(a[13]=c("."))])])),_:1}),i(j,{class:"mb-4",variant:"outlined"},{default:r((()=>[i(h,null,{default:r((()=>[a[20]||(a[20]=n("h3",{class:"text-h6 mb-3"},"Booking Details",-1)),n("div",D,[a[15]||(a[15]=n("span",{class:"font-weight-medium"},"Room:",-1)),n("span",null,d(f.room.title),1)]),n("div",k,[a[16]||(a[16]=n("span",{class:"font-weight-medium"},"Check-in:",-1)),n("span",null,d(F.value.checkInDate),1)]),n("div",_,[a[17]||(a[17]=n("span",{class:"font-weight-medium"},"Check-out:",-1)),n("span",null,d(F.value.checkOutDate),1)]),n("div",w,[a[18]||(a[18]=n("span",{class:"font-weight-medium"},"Guests:",-1)),n("span",null,d(F.value.adults)+" adults, "+d(F.value.children)+" children",1)]),n("div",I,[a[19]||(a[19]=n("span",{class:"font-weight-medium"},"Total Price:",-1)),n("span",V,"$"+d(H.value),1)])])),_:1})])),_:1}),n("div",x,[i(C,{color:"primary",to:"/bookings",class:"ma-2"},{default:r((()=>a[21]||(a[21]=[c(" View My Bookings ")]))),_:1}),i(C,{color:"secondary",variant:"outlined",to:"/",class:"ma-2"},{default:r((()=>a[22]||(a[22]=[c(" Return to Home ")]))),_:1})])])):(s(),u(ue,{key:1,onSubmit:p(Q,["prevent"])},{default:r((()=>[A.value?(s(),u(l,{key:0,type:"error",variant:"tonal",class:"mb-4",closable:""},{default:r((()=>[c(d(A.value),1)])),_:1})):m("",!0),!L.value&&F.value.checkInDate&&F.value.checkOutDate?(s(),u(l,{key:1,type:"warning",variant:"tonal",class:"mb-4",closable:""},{default:r((()=>a[23]||(a[23]=[c(" This room is not available for the selected dates. Please choose different dates. ")]))),_:1})):m("",!0),n("div",q,[i(G,null,{default:r((()=>[i(z,{cols:"12",sm:"4"},{default:r((()=>[i(S,{src:f.room.image,height:"150",cover:"",class:"rounded"},null,8,["src"])])),_:1}),i(z,{cols:"12",sm:"8"},{default:r((()=>[n("h3",O,d(f.room.title),1),n("p",T,d(f.room.description),1),n("div",N,[n("span",$,d(f.room.price),1),a[24]||(a[24]=n("span",{class:"text-body-2 ml-1"},"per night",-1))])])),_:1})])),_:1})]),i(X,{class:"mb-6"}),a[27]||(a[27]=n("h3",{class:"text-h6 font-weight-bold mb-4"},"Stay Details",-1)),i(G,null,{default:r((()=>[i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ee,{modelValue:F.value.checkInDate,"onUpdate:modelValue":a[0]||(a[0]=e=>F.value.checkInDate=e),label:"Check-in Date",type:"date",min:v(K),rules:[U.required],variant:"outlined",required:""},null,8,["modelValue","min","rules"])])),_:1}),i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ee,{modelValue:F.value.checkOutDate,"onUpdate:modelValue":a[1]||(a[1]=e=>F.value.checkOutDate=e),label:"Check-out Date",type:"date",min:W.value,rules:[U.required],variant:"outlined",disabled:!F.value.checkInDate,required:""},null,8,["modelValue","min","rules","disabled"])])),_:1})])),_:1}),i(G,null,{default:r((()=>[i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ae,{modelValue:F.value.adults,"onUpdate:modelValue":a[2]||(a[2]=e=>F.value.adults=e),label:"Adults",items:[1,2,3,4],variant:"outlined",required:""},null,8,["modelValue"])])),_:1}),i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ae,{modelValue:F.value.children,"onUpdate:modelValue":a[3]||(a[3]=e=>F.value.children=e),label:"Children",items:[0,1,2,3,4],variant:"outlined"},null,8,["modelValue"])])),_:1})])),_:1}),Y.value>0?(s(),u(j,{key:2,class:"mb-6",variant:"outlined"},{default:r((()=>[i(h,null,{default:r((()=>[n("div",P,[n("span",null,d(f.room.price)+" x "+d(Y.value)+" nights",1),n("span",null,"$"+d(Z.value*Y.value),1)]),i(X,{class:"my-2"}),n("div",R,[a[25]||(a[25]=n("span",null,"Total",-1)),n("span",null,"$"+d(H.value),1)])])),_:1})])),_:1})):m("",!0),i(X,{class:"mb-6"}),a[28]||(a[28]=n("h3",{class:"text-h6 font-weight-bold mb-4"},"Guest Information",-1)),i(G,null,{default:r((()=>[i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ee,{modelValue:F.value.firstName,"onUpdate:modelValue":a[4]||(a[4]=e=>F.value.firstName=e),label:"First Name",rules:[U.required],variant:"outlined",required:""},null,8,["modelValue","rules"])])),_:1}),i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ee,{modelValue:F.value.lastName,"onUpdate:modelValue":a[5]||(a[5]=e=>F.value.lastName=e),label:"Last Name",rules:[U.required],variant:"outlined",required:""},null,8,["modelValue","rules"])])),_:1})])),_:1}),i(G,null,{default:r((()=>[i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ee,{modelValue:F.value.email,"onUpdate:modelValue":a[6]||(a[6]=e=>F.value.email=e),label:"Email",type:"email",rules:[U.required,U.email],variant:"outlined",required:""},null,8,["modelValue","rules"])])),_:1}),i(z,{cols:"12",sm:"6"},{default:r((()=>[i(ee,{modelValue:F.value.phone,"onUpdate:modelValue":a[7]||(a[7]=e=>F.value.phone=e),label:"Phone",rules:[U.required,U.phone],variant:"outlined",required:""},null,8,["modelValue","rules"])])),_:1})])),_:1}),i(le,{modelValue:F.value.specialRequests,"onUpdate:modelValue":a[8]||(a[8]=e=>F.value.specialRequests=e),label:"Special Requests",variant:"outlined",rows:"3"},null,8,["modelValue"]),i(X,{class:"mb-6"}),a[29]||(a[29]=n("h3",{class:"text-h6 font-weight-bold mb-4"},"Payment Method",-1)),i(oe,{modelValue:F.value.paymentMethod,"onUpdate:modelValue":a[9]||(a[9]=e=>F.value.paymentMethod=e),inline:""},{default:r((()=>[i(te,{label:"Credit Card",value:"credit-card"}),i(te,{label:"PayPal",value:"paypal"}),i(te,{label:"Pay at Property",value:"at-property"})])),_:1},8,["modelValue"]),i(X,{class:"mb-6"}),i(se,{modelValue:F.value.agreeToTerms,"onUpdate:modelValue":a[10]||(a[10]=e=>F.value.agreeToTerms=e),label:"I agree to the terms and conditions",rules:[U.required],required:""},null,8,["modelValue","rules"]),i(C,{color:"primary",size:"large",type:"submit",block:"",loading:M.value,disabled:!J.value||!L.value||M.value,class:"mt-4"},{default:r((()=>a[26]||(a[26]=[c(" Complete Booking ")]))),_:1},8,["loading","disabled"])])),_:1}))])}}},[["__scopeId","data-v-fe1caabe"]]);export{j as B};
